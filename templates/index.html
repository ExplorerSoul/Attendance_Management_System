<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Attendance Dashboard</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">

  <style>
    body { background: #f5f7fb; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .top-cards .card { border-radius: 12px; box-shadow: 0 6px 18px rgba(22,22,60,0.06); }
    .filter-box { background: #fff; padding: 12px; border-radius: 10px; }
    .chart-card { height: 240px; }
    .pointer { cursor:pointer; }
  </style>
</head>
<body>
  <div class="container py-4">
    <header class="d-flex align-items-center justify-content-between mb-4">
      <div>
        <h1 class="h3 mb-1">Attendance Dashboard</h1>
        <div class="small text-muted">Overview, per-class stats and student attendance percentages</div>
      </div>
      <div class="text-end">
        <div class="small text-muted">Total Students</div>
        <div class="fs-3 fw-bold">{{ total_students }}</div>
      </div>
    </header>

    <!-- Filters + Export -->
    <div class="row g-3 mb-3">
      <div class="col-lg-9">
        <div class="card p-3 filter-box">
          <form id="filterForm" method="POST" action="/view" class="row g-2 align-items-end">
            <div class="col-md-4">
              <label class="form-label small text-muted">Class</label>
              <select name="class_id" id="classSelect" class="form-select">
                <option value="">All Classes</option>
                {% for cid, cname in classes %}
                  <option value="{{ cid }}" {% if selected_class == cid %}selected{% endif %}>{{ cname }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-3">
              <label class="form-label small text-muted">From</label>
              <input type="date" name="date_from" id="dateFrom" class="form-control" value="{{ selected_date_from }}">
            </div>

            <div class="col-md-3">
              <label class="form-label small text-muted">To</label>
              <input type="date" name="date_to" id="dateTo" class="form-control" value="{{ selected_date_to }}">
            </div>

            <div class="col-md-2 d-grid">
              <button class="btn btn-primary" type="submit">Apply</button>
            </div>
          </form>
        </div>
      </div>

      <div class="col-lg-3">
        <div class="card p-3 h-100">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="small text-muted">Attendance Records</div>
              <div class="h4 fw-bold">{{ total_records }}</div>
            </div>
            <div class="text-end">
              <div class="small text-muted">Classes</div>
              <div class="h5">{{ total_classes }}</div>
            </div>
          </div>

          <div class="mt-3">
            <!-- Export as CSV button triggers query GET to /export_csv -->
            <button id="exportCsvBtn" class="btn btn-outline-primary w-100">Export CSV</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Class overview -->
    <div class="row g-3 mb-3">
      {% for cid, cname, total_sessions, total_attendances, avg_pct in class_overview %}
        <div class="col-md-4">
          <div class="card p-3 h-100">
            <div class="d-flex justify-content-between">
              <div>
                <div class="small text-muted">Class</div>
                <div class="h5 fw-bold">{{ cname }}</div>
                <div class="small text-muted mt-1">Sessions: {{ total_sessions }}</div>
              </div>
              <div class="text-end">
                <div class="small text-muted">Avg Attendance</div>
                <div class="h4 fw-bold">{{ avg_pct }}%</div>
                <div class="small text-muted">{{ total_attendances }} entries</div>
              </div>
            </div>
            <div class="mt-3 chart-card">
              <canvas id="chart-{{ cid }}" data-class-id="{{ cid }}"></canvas>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>

    <!-- Student table -->
    <div class="card p-3">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">Student Attendance (%)</h5>
        <div class="small text-muted">Click a row to view detailed dates</div>
      </div>

      {% if message %}
        <div class="alert alert-warning">{{ message }}</div>
      {% endif %}

      <div class="table-responsive">
        <table id="studentTable" class="table table-striped table-hover">
          <thead>
            <tr>
              <th>Roll No</th>
              <th>Name</th>
              <th>Attended</th>
              <th>Sessions</th>
              <th>Percentage</th>
            </tr>
          </thead>
          <tbody>
            {% for s in student_attendance %}
              <tr class="student-row pointer" data-roll="{{ s.roll_no }}">
                <td>{{ s.roll_no }}</td>
                <td>{{ s.name }}</td>
                <td>{{ s.attended }}</td>
                <td>{{ s.total_sessions }}</td>
                <td>{{ "%.1f"|format(s.percentage) }}%</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <footer class="mt-4 text-center small text-muted">
      Powered by Face Attendance System â€” public viewer
    </footer>
  </div>

  <!-- Student details modal -->
  <div class="modal fade" id="studentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Student Attendance Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="studentDetailsHeader" class="mb-2"></div>
          <table class="table table-sm">
            <thead>
              <tr><th>Date</th><th>Class</th><th>Time</th></tr>
            </thead>
            <tbody id="studentDetailsBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>

  <!-- DataTables -->
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

  <script>
    $(document).ready(function() {
      // DataTable
      var table = $('#studentTable').DataTable({
        "order": [[4, "desc"]],
        "pageLength": 25,
        "lengthMenu": [10, 25, 50, 100]
      });

      // Row click -> student details modal
      $('#studentTable tbody').on('click', 'tr.student-row', function() {
        var roll = $(this).data('roll');
        if (!roll) return;
        $('#studentDetailsHeader').text('Roll: ' + roll);
        $('#studentDetailsBody').html('<tr><td colspan="3">Loading...</td></tr>');
        var date_from = $('#dateFrom').val();
        var date_to = $('#dateTo').val();
        $.getJSON('/student/' + encodeURIComponent(roll) + '/attendance', {date_from: date_from, date_to: date_to})
          .done(function(data) {
            if (!data || data.length === 0) {
              $('#studentDetailsBody').html('<tr><td colspan="3">No records found.</td></tr>');
            } else {
              var html = '';
              data.forEach(function(r) {
                html += '<tr><td>' + r.date + '</td><td>' + r.class_name + '</td><td>' + (r.time || '') + '</td></tr>';
              });
              $('#studentDetailsBody').html(html);
            }
            var modal = new bootstrap.Modal(document.getElementById('studentModal'));
            modal.show();
          }).fail(function() {
            $('#studentDetailsBody').html('<tr><td colspan="3">Failed to fetch details.</td></tr>');
            var modal = new bootstrap.Modal(document.getElementById('studentModal'));
            modal.show();
          });
      });

      // Export CSV button builds query params and navigates to /export_csv
      $('#exportCsvBtn').on('click', function() {
        var class_id = $('#classSelect').val() || '';
        var date_from = $('#dateFrom').val() || '';
        var date_to = $('#dateTo').val() || '';
        var params = $.param({class_id: class_id, date_from: date_from, date_to: date_to});
        window.location = '/export_csv?' + params;
      });

      // Build charts for each class canvas
      document.querySelectorAll('canvas[id^="chart-"]').forEach(function(c) {
        var classId = c.dataset.classId;
        var date_from = $('#dateFrom').val() || '';
        var date_to = $('#dateTo').val() || '';
        fetch('/class_trend/' + classId + '?date_from=' + encodeURIComponent(date_from) + '&date_to=' + encodeURIComponent(date_to))
          .then(r => r.json())
          .then(json => {
            var ctx = c.getContext('2d');
            new Chart(ctx, {
              type: 'line',
              data: {
                labels: json.labels,
                datasets: [{
                  label: 'Students present',
                  data: json.data,
                  tension: 0.3,
                  fill: true,
                  backgroundColor: 'rgba(54,162,235,0.12)',
                  borderColor: 'rgba(54,162,235,1)',
                  pointRadius: 3
                }]
              },
              options: {
                plugins: { legend: { display: false }},
                scales: {
                  x: { display: true, title: { display: false } },
                  y: { beginAtZero: true, precision: 0 }
                }
              }
            });
          }).catch(err => {
            // no data or error -> draw nothing
            console.error('chart err', err);
          });
      });
    });
  </script>
</body>
</html>
